name: Pre-Release Build

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  check:
    name: Run flake checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run flake check
        run: nix flake check -L

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    needs: [check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build WASM
        run: nix build .#mitchty-wasm -L

      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp -r result/wasm dist/
          ls -lh dist/wasm/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mitchty-wasm
          path: dist/wasm
          if-no-files-found: error

  build-windows:
    name: Build Windows (MinGW cross-compile)
    runs-on: ubuntu-latest
    needs: [check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build Windows binary
        run: nix build .#mitchty-release-windows -L

      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp result/bin/mitchty.exe dist/mitchty-windows-x86_64.exe
          chmod +x dist/mitchty-windows-x86_64.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mitchty-windows-x86_64
          path: dist/mitchty-windows-x86_64.exe
          if-no-files-found: error

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: [check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build macOS binary
        run: nix build .#mitchty-release -L

      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp result/bin/mitchty dist/mitchty-darwin-aarch64
          chmod +x dist/mitchty-darwin-aarch64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mitchty-darwin-aarch64
          path: dist/mitchty-darwin-aarch64
          if-no-files-found: error

  create-prerelease:
    name: Create Pre-Release
    needs: [build-wasm, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Create a tarball of WASM files
          cd artifacts/mitchty-wasm
          tar czf ../../release/mitchty-wasm.tar.gz *
          cd ../..
          cp artifacts/mitchty-windows-x86_64/mitchty-windows-x86_64.exe release/
          cp artifacts/mitchty-darwin-aarch64/mitchty-darwin-aarch64 release/
          ls -lh release/

      - name: Delete existing pre-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Delete the pre-release tag and release if it exists
          if gh release view pre-release >/dev/null 2>&1; then
            echo "Deleting existing pre-releases"
            gh release delete pre-release --yes --cleanup-tag
          fi

      - name: Create pre-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create pre-release \
            --title "latest main" \
            --notes "automated pre-release build off current main commit

          commit: ${{ github.sha }}

          ### WASM (Web)

          Visit [mitchty.github.com](https://mitchty.github.com) to run the WASM version in your browser.

          Or download \`mitchty-wasm.tar.gz\` to host it yourself.

          ### Native Downloads

          **macOS (Apple Silicon):**
          \`\`\`bash
          curl -Lo mitchty https://github.com/${{ github.repository }}/releases/download/pre-release/mitchty-darwin-aarch64
          chmod +x mitchty
          ./mitchty
          \`\`\`

          **Windows (x86_64):**
          Download \`mitchty-windows-x86_64.exe\` and run it.

          Note: Windows build is cross-compiled and largely untested.

          ---
          **Note:** These are pre-release builds from the main development branch and may be broken." \
            --prerelease \
            --draft \
            release/mitchty-wasm.tar.gz \
            release/mitchty-windows-x86_64.exe \
            release/mitchty-darwin-aarch64
